let KMonoTri =[
    {
        natureTroncon:"aerien nu",
        ameTroncon:"cuivre",
        ktri:21,
        kmono:21
    },
    {
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        ktri:18.6,
        kmono:20
    },
    {
        natureTroncon:"aerien isole",
        ameTroncon:"aluminium",
        ktri:14,
        kmono:16
    },
    {
        natureTroncon:"souterrain",
        ameTroncon:"cuivre",
        ktri:20,
        kmono:24
    },
    {
        natureTroncon:"souterrain",
        ameTroncon:"aluminium",
        ktri:15.3,
        kmono:18.4
    }
]

let table=[
    {section:0.5,
     natureTroncon:"aerien isole",
     ameTroncon:"cuivre",
     intensiteNominaleTri:0,
     intensiteNominaleMono:10
    },
    {section:0.5,
     natureTroncon:"Souterrain",
     ameTroncon:"cuivre",
     intensiteNominaleTri:0,
     intensiteNominaleMono:0
    },
    {section:0.75,
        natureTroncon:"aerien isol√©",
        ameTroncon:"cuivre",
        intensiteNominaleTri:12,
        intensiteNominaleMono:13.5
    },
    {section:0.75,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:0,
        intensiteNominaleMono:0
       },
       {section:1,
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        intensiteNominaleTri:14,
        intensiteNominaleMono:15
       },
       {section:1,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:0,
        intensiteNominaleMono:0
       },
       {section:1.5,
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        intensiteNominaleTri:18,
        intensiteNominaleMono:20
       },
       {section:1.5,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:15,
        intensiteNominaleMono:18
       },
       {section:2.5,
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        intensiteNominaleTri:24,
        intensiteNominaleMono:26
       },
       {section:2.5,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:20,
        intensiteNominaleMono:24
       },
       {section:4,
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        intensiteNominaleTri:32,
        intensiteNominaleMono:35
       },
       {section:4,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:26,
        intensiteNominaleMono:32
       },
       {section:6,
        natureTroncon:"aerien isole",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:0,
        intensiteNominaleMono:0
       },
       {section:6,
        natureTroncon:"Souterrain",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:0,
        intensiteNominaleMono:0
       },
       {section:6,
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        intensiteNominaleTri:52,
        intensiteNominaleMono:58
       },
       {section:6,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:64,
        intensiteNominaleMono:74
       },
       {section:10,
        natureTroncon:"aerien isole",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:0,
        intensiteNominaleMono:0
       },
       {section:10,
        natureTroncon:"Souterrain",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:0,
        intensiteNominaleMono:0
       },
       {section:10,
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        intensiteNominaleTri:71,
        intensiteNominaleMono:80
       },
       {section:10,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:88,
        intensiteNominaleMono:101
       },
       {section:16,
        natureTroncon:"aerien isole",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:74,
        intensiteNominaleMono:83
       },
       {section:16,
        natureTroncon:"Souterrain",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:87,
        intensiteNominaleMono:100
       },
       {section:16,
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        intensiteNominaleTri:96,
        intensiteNominaleMono:107
       },
       {section:16,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:111,
        intensiteNominaleMono:1
       },

       {section:25,
        natureTroncon:"aerien isole",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:97,
        intensiteNominaleMono:108
       },
       {section:25,
        natureTroncon:"Souterrain",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:110,
        intensiteNominaleMono:126
       },
       {section:25,
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        intensiteNominaleTri:127,
        intensiteNominaleMono:142
       },
       {section:25,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:141,
        intensiteNominaleMono:162
       },


       {section:35,
        natureTroncon:"aerien isole",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:118,
        intensiteNominaleMono:138
       },
       {section:35,
        natureTroncon:"Souterrain",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:133,
        intensiteNominaleMono:152
       },
       {section:35,
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        intensiteNominaleTri:157,
        intensiteNominaleMono:175
       },
       {section:35,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:170,
        intensiteNominaleMono:195
       },

       {section:50,
        natureTroncon:"aerien isole",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:141,
        intensiteNominaleMono:0
       },
       {section:50,
        natureTroncon:"Souterrain",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:159,
        intensiteNominaleMono:0
       },
       {section:50,
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        intensiteNominaleTri:190,
        intensiteNominaleMono:0
       },
       {section:50,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:204,
        intensiteNominaleMono:0
       },
       
       {section:70,
        natureTroncon:"aerien isole",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:180,
        intensiteNominaleMono:0
       },
       {section:70,
        natureTroncon:"Souterrain",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:197,
        intensiteNominaleMono:0
       },
       {section:70,
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        intensiteNominaleTri:242,
        intensiteNominaleMono:0
       },
       {section:70,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:252,
        intensiteNominaleMono:0
       },

       {section:95,
        natureTroncon:"aerien isole",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:258,
        intensiteNominaleMono:0
       },
       {section:95,
        natureTroncon:"Souterrain",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:236,
        intensiteNominaleMono:0
       },
       {section:95,
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        intensiteNominaleTri:293,
        intensiteNominaleMono:0
       },
       {section:95,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:302,
        intensiteNominaleMono:0
       },

       {section:150,
        natureTroncon:"aerien isole",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:309,
        intensiteNominaleMono:0
       },
       {section:150,
        natureTroncon:"Souterrain",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:301,
        intensiteNominaleMono:0
       },
       {section:150,
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        intensiteNominaleTri:390,
        intensiteNominaleMono:0
       },
       {section:150,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:386,
        intensiteNominaleMono:0
       },

       {section:240,
        natureTroncon:"aerien isole",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:415,
        intensiteNominaleMono:0
       },
       {section:240,
        natureTroncon:"Souterrain",
        ameTroncon:"Aluminium",
        intensiteNominaleTri:393,
        intensiteNominaleMono:0
       },
       {section:240,
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        intensiteNominaleTri:522,
        intensiteNominaleMono:0
       },
       {section:240,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:504,
        intensiteNominaleMono:0
       },
       {section:300,
        natureTroncon:"aerien isole",
        ameTroncon:"cuivre",
        intensiteNominaleTri:595,
        intensiteNominaleMono:0
       },
       {section:300,
        natureTroncon:"Souterrain",
        ameTroncon:"cuivre",
        intensiteNominaleTri:571,
        intensiteNominaleMono:0
       }]
       


let KfMonoPhase=[
    {
        minCumul:1,
        maxCumul:3,
        kf:1
    },
    {
        minCumul:4,
        maxCumul:6,
        kf:0.78
    },
    {
        minCumul:7,
        maxCumul:9,
        kf:0.63
    },
    {
        minCumul:10,
        maxCumul:13,
        kf:0.53
    },
    {
        minCumul:14,
        maxCumul:16,
        kf:0.49
    },
    {
        minCumul:17,
        maxCumul:19,
        kf:0.46
    },
    {
        minCumul:20,
        maxCumul:23,
        kf:0.44
    },
    {
        minCumul:24,
        maxCumul:26,
        kf:0.42
    },
    {
        minCumul:27,
        maxCumul:33,
        kf:0.41
    },
    {
        minCumul:34,
        kf:0.4
    }


]


let kfTriphase = [
    {
        minCumul:1,
        maxCumul:4,
        kf:1
    },
    {
        minCumul:5,
        maxCumul:9,
        kf:0.78
    },
    {
        minCumul:10,
        maxCumul:14,
        kf:0.63
    },
    {
        minCumul:15,
        maxCumul:19,
        kf:0.53
    },
    {
        minCumul:20,
        maxCumul:24,
        kf:0.49
    },
    {
        minCumul:25,
        maxCumul:29,
        kf:0.46
    },
    {
        minCumul:30,
        maxCumul:34,
        kf:0.44
    },
    {
        minCumul:35,
        maxCumul:39,
        kf:0.42
    },
    {
        minCumul:40,
        maxCumul:49,
        kf:0.41
    },
    {
        minCumul:50,
        kf:0.4
    },
]


let lengthTable = table.length;


 let Tab = [];
 let Max = tab.length;
 let CosPhi = "Valeur √† recup du form 1";
 let NatReseau = "Valeur Type r√©seau Mono ou Tri √† recup du form 1"
 let U0 = "Valeur Tension Initiale √† recup du form1";
 let P0 = "Puissance par client √† recup du form1";
 let X1 = 0;
 let R0 = 0;
 let natureTroncon = 0;
 let section = 0 ;
 let ameTroncon =  0  ; 
 function PuissanceNoeud (i)
 {
      let res = P0*Tab[i].NbAbonneNoeud
      return res ;
 }

 function Cumul(i,ColName)
 {
     /* Cumul √† partir de l'indice i (noeud) des donn√©es d'une Colonne ColName
     (Colonne du Tableau de Cartographie) donn√©e en string*/
     let Cumul = 0;
     for (let k = i; k< Max; k++)
     {
         Cumul+= Tab[k].ColName;
     }
     return Cumul;
 }

function TabCumulAbonnes(){
    let TabCumul;
    let Cumul = 0; 
    //TabCumul est un tableau √† deux colonnes {"NumNoeud","CumulAbonnes"}
    for (let i=Max-1; i>=0;i--){
        Cumul = Tab[i].NombreNoeudAbonnes;
        for (let j=Max-1; j>i; j--){
            if(Tab[i].NumNoeudActuel===Tab[j].NumNoeudAmont){
                for(let k=0;k<TabCumul.Length; k++){
                    if(Tab[j].NumNoeudAmont === TabCumul[k].NumNoeud){
                        Cumul+=TabCumul[k].NumNoeud;
                        break;
                    }
                }
            }
        }
        TabCumul+={Tab[i].NumNoeudActuel,Cumul};
    }
}

 function CumulPuissanceFoisonnee(kf,i,colName){
     let cumul = Cumul(i,colName);
     let res = kf*cumul*P0;
      return res;
  }


  function CumulPuissanceNoeud(cumulChargePro ,CumPuiFois){
    //CumulChargePro : Cumul des charges professionnels au noeud( fonction cumul(i, colonnePuissanceChargePro)
      //CumPuiFois: en utilisant fonction cumulPuissanceFoissonn√©e
      let res = CumPuiFois + cumulChargePro;
      return res;
  }

 //TabTension a creer 
function Tension(i){
    let result = 0 ; 
    for(let k = 0 ; k< TabTension.length ; k++){
        if(TabTension[k].colNoeud === Tab[i].NoeudAmont){
            result = TabTension[k].colTension;
            return result ;
        }
    }
    
}






 // Chute de tension au n≈ìud actuel
 function ChuteTensionNoeud(i , CumulPuiss){
     let TensionNoeudAmont = Tension(i) ;// recuperer dans un tableau de tension  par noeud 
     /*E nfonction de l'indice du noeud dans le tableau, on recup√®re les param√®tres tels que la r√©actance X1 et la r√©sistivit√© R0 
       puis on calcule les Chutes de Tension au noeud i*/
     //CumulPuiss = Cumul de la puissance au noeud i √† calculer √† l'aide dela fonction CumulPuissanceNoeud
     if (Tab[i].Nature === "aerien nu"){
         X1 = 0,35 ;
     }
     else if (Tab[i].Nature === "aerien isole" || "souterrain"){
         X1 = 0,1 ;
     }
    if (Tab[i].Ame === "aluminium"){
         R0 = 30 ;
     }
     else if (Tab[i].Ame === "cuivre"){
         R0 = 18 ;
     }
       
     let Result = CumulPuiss*Tab[i].Nature*((R0/Tab[i].Section) + X1*Math.sqrt((1/(CosPhi*CosPhi))-1))/TensionNoeudAmont);
  
     if(NatReseau === "triphase"){
         //Chute de tension au n≈ìud actuel - Triphas√©
         return Result;
     }
     else if (NatReseau === "monophase"){
         //Chute de tension au n≈ìud actuel - Monophas√©
         return 2*Result;
     }
 }
//Cumul chute de tension au noeud actuel

 function CumulChuteTensionNoeudActuel(i , cumulPuiss){
      //CumulPuiss = Cumul de la puissance au noeud i √† calculer √† l'aide dela fonction CumulPuissanceNoeud

  let CumulTensionAmont = 0;
  let chuteNoeud = ChuteTensionNoeud(i,cumulPuiss); //
  // Calcul cumulTension noeud Tension
  for(let k=i ; k>0 ; k--){
      
      
   CumulTensionAmont +=ChuteTensionNoeud(k) 
  }
  let res = chuteNoeud + CumulTensionAmont;
  return res ;
 }
// TensionNoeudActuel
 function TensionNoeudActuel(i, CumulChuteTensionNoeud){
     //CumulChuteTensionNoeud: cumul chutes de tension au noeud i(fonction CumulChuteTensionNoeudActuel(i)
     
  if(i==0 ){
   return res = U0;
  else{
       //let tensionAmont = TensionNoeudActuel(i-1);
       //let chuteTensionNoeudActuel = ChuteTensionNoeud(i , cumulPuiss);
       let result = Tension(i) - ChuteTensionNoeud(i, cumulPuiss);
  return result ;
  }

// //Chute de tension relative
 function ChuteTensionRelative(i, CumulPuiss){
    //CumulPuiss = Cumul de la puissance au noeud i √† calculer √† l'aide dela fonction CumulPuissanceNoeud
     return 100*CumulChuteTensionNoeudActuel(i, CumulPuiss)/U0; 
 }

// //Intensit√© Cable
 function IntensiteCable(i,CumulPuiss, tensionNoeudAct){
     //CumulPuiss = Cumul de la puissance au noeud i √† calculer √† l'aide dela fonction CumulPuissanceNoeud
     // tensionNoeudAct = Tension Noeud Actuel (fonction TensionNoeudActuel)
     let Result = CumulPuiss/(tensionNoeudAct*CosPhi);
    
     if(NatReseau === "triphase"){
         //Intensit√© Cable - Triphas√©
         return Result/Math.sqrt(3);
     }
     else if (NatReseau === "monophase"){
         //Intensit√© Cable - Monophas√©
         return Result;
     }
 }
 }

// TAUX DE CHARGE 

function TauxDeCharge(i , ICable){
    //ICable = Intensit√© cable noeud actuel(fonction IntensiteCable)
    let kTri= 0;
    let kMono= 0
    for(let i =0 ; i<lengthTable ; i++){
        if(Tab[i].Section===table[i].section && Tab[i].Nature===table[i].natureTroncon && Tab[i].Ame===table[i].ameTroncon){
            if(NatReseau==='triphase' && table[i].intensiteNominaleTri !=0 ){
                let result = 100*ICable/table[i].intensiteNominaleTri;
                return result;
            }else if(NatReseau==='monophase' && table[i].intensiteNominaleMono !=0){
                let result = 100*ICable/table[i].intensiteNominaleMono;
                return result;
            }
            else if(NatReseau==='triphase' && table[i].intensiteNominaleTri ==0){
                    for(let j = 0 ; j<6 ; j++){
                        if( Kmonotri[j].natureTroncon===Tab[i].Nature &&  Kmonotri[j].ameTroncon===Tab[i].Ame){
                            kTri= kmonotri[j].ktri;
                        }
                    }
               let Inominal = KTri*Math.pow(Tab[i].Section,0.6)  
               let result = 100*ICable/Inominal;
                return result ; 

            }
            else{
                for(let j = 0 ; j<6 ; j++){
                        if( Kmonotri[j].natureTroncon===Tab[i].Nature &&  Kmonotri[j].ameTroncon===Tab[i].Ame){
                            kMono= kmonotri[j].kmono;
                        }
                    }
                
                
                let Inominal = KMono*Math.pow(Tab[i].Section,0.6);     
                let result = 100*ICable/Inominal;
                return result ;
            }   
                
            }
        }
    }


}

// D√©termination kf 
function CoefFoisonnement (Cumul){
    if(NatReseau === "Triphas√©"){
                 let Table = kfTriphase;
             }
    else if (NatReseau === "Monophase"){
                let Table = kfTriphase;
    }
    for(let i = 0;i<Table.length;i++){
        if(Cumul>=Table[i].minCumul  && Cumul<=Table[i].maxCumul){
            return Table[i].kf
        }
        else {
           return 0;    
        }
    } 
}

//
